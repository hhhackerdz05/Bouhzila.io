<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bouhzila.io - لعبة البوحزيلة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* خط رقمي رياضي */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #0d0d21; /* خلفية داكنة جداً */
            color: #E0E0FF;
        }
        
        #gameCanvas {
            border-radius: 12px;
            box-shadow: 0 0 50px rgba(75, 0, 130, 0.7); /* ظل بنفسجي ساطع */
            background-color: #1a0a2e; /* خلفية حقل اللعب */
            cursor: crosshair;
            transition: box-shadow 0.3s ease-in-out;
        }
        #gameCanvas:hover {
            box-shadow: 0 0 60px rgba(100, 0, 160, 0.9);
        }

        .ui-panel {
            background-color: rgba(26, 10, 46, 0.9); /* خلفية شبه شفافة داكنة */
            backdrop-filter: blur(5px);
            border-radius: 8px;
            padding: 1.25rem;
            border: 1px solid #4a0e7e; /* إطار بنفسجي خفيف */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            color: #E0E0FF;
            z-index: 10;
        }

        /* لوحة القيادة العلوية */
        #dashboard {
            width: 90%;
            max-width: 600px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.5rem;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        .dashboard-item span {
            font-weight: 900;
            color: #8A2BE2; /* لون بنفسجي ساطع للقيم */
        }

        /* قائمة المتصدرين */
        #leaderboard-list li {
            padding: 0.4rem 0;
            border-bottom: 1px dashed rgba(74, 14, 126, 0.5); /* خط منقط خفيف */
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        #leaderboard-list li:last-child {
            border-bottom: none;
        }
        #leaderboard-list li:nth-child(1) { color: #FFD700; /* ذهبي */ font-weight: 900; }
        #leaderboard-list li:nth-child(2) { color: #C0C0C0; /* فضي */ }
        #leaderboard-list li:nth-child(3) { color: #CD7F32; /* برونزي */ }
    </style>
</head>
<body>

    <!-- Main Game Container -->
    <div id="game-container" class="relative flex flex-col items-center">
        
        <!-- Dashboard (Score & FPS) -->
        <div id="dashboard" class="ui-panel hidden">
            <div class="dashboard-item">
                الدرجة (Score): <span id="current-score">0</span>
            </div>
            <div class="dashboard-item text-xs text-gray-400">
                معدل الإطار (FPS): <span id="fps-display">--</span>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>

        <!-- UI Elements -->
        <div id="connection-status" class="absolute top-4 left-4 text-sm px-3 py-1 rounded-full transition-colors duration-300 bg-red-800 text-white font-bold">
            جاري الاتصال...
        </div>

        <!-- Leaderboard -->
        <div id="leaderboard" class="ui-panel absolute top-4 right-4 w-64 hidden md:block">
            <h3 class="text-xl font-bold mb-3 text-center border-b border-purple-600 pb-2">لوحة المتصدرين</h3>
            <ul id="leaderboard-list" class="text-sm">
                <!-- سيتم إدراج عناصر لوحة المتصدرين هنا -->
            </ul>
        </div>

        <!-- Name Input Modal -->
        <div id="name-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
            <div class="ui-panel max-w-lg w-full p-8 text-center border-2 border-purple-700">
                <h1 class="text-4xl font-black mb-6 text-purple-400">Bouhzila.io</h1>
                <h2 class="text-xl mb-6">أدخل اسمك للانضمام إلى المعركة!</h2>
                <input type="text" id="player-name-input" placeholder="اسم البوحزيلة الخاص بك..." class="w-full p-4 rounded-lg mb-6 text-black bg-white focus:ring-4 focus:ring-purple-500 transition duration-150 border-none text-lg">
                <button id="start-game-button" class="w-full bg-purple-600 hover:bg-purple-500 active:bg-purple-700 text-white font-black py-4 rounded-lg transition duration-200 shadow-xl shadow-purple-900/50 transform hover:scale-[1.02]">
                    العب الآن
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- GAME CLIENT LOGIC ---

        // Global state and constants
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const nameModal = document.getElementById('name-modal');
        const playerNameInput = document.getElementById('player-name-input');
        const startGameButton = document.getElementById('start-game-button');
        const connectionStatus = document.getElementById('connection-status');
        const leaderboardList = document.getElementById('leaderboard-list');
        const currentScoreDisplay = document.getElementById('current-score');
        const fpsDisplay = document.getElementById('fps-display');
        const dashboard = document.getElementById('dashboard');

        let ws = null;
        let gameState = { players: [], food: [] };
        let myId = null;
        let myPlayer = null;
        let worldSize = { width: 3000, height: 3000 };
        let camera = { x: 0, y: 0 };
        let mousePos = { x: 0, y: 0 };
        let lastInputTime = 0;
        const INPUT_DELAY = 1000 / 60; // Send input at 60 FPS

        // FPS tracking
        let lastFrameTime = performance.now();
        let fps = 0;

        // --- التحديث الحاسم: استخدام رابط WSS الثابت من سجلات الخادم ---
        // العنوان الثابت للخادم الخلفي الذي يعمل على Render
        const SERVER_URL = 'wss://bouhzila-io-1.onrender.com';


        // --- Connection Management ---

        function connectToServer() {
            // Update status and try to connect
            connectionStatus.textContent = 'جاري الاتصال...';
            connectionStatus.className = 'absolute top-4 left-4 text-sm px-3 py-1 rounded-full bg-yellow-600 text-white font-bold';

            console.log(`Attempting connection to: ${SERVER_URL}`);

            try {
                // استخدام الرابط الثابت مباشرة
                ws = new WebSocket(SERVER_URL);
            } catch (error) {
                console.error("WebSocket creation failed (Check browser support or URL protocol):", error);
                connectionStatus.textContent = 'فشل الاتصال';
                connectionStatus.className = 'absolute top-4 left-4 text-sm px-3 py-1 rounded-full bg-red-600 text-white font-bold';
                return;
            }

            ws.onopen = () => {
                connectionStatus.textContent = 'متصل';
                connectionStatus.className = 'absolute top-4 left-4 text-sm px-3 py-1 rounded-full bg-green-600 text-white font-bold';
                console.log('WebSocket connected.');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'init') {
                    myId = data.id;
                    worldSize = data.world;
                    console.log('Received initial setup. My ID:', myId);
                    // Show the name modal after connection
                    nameModal.classList.remove('hidden');
                } else {
                    // This is the game state update
                    gameState = data;
                }
            };

            ws.onclose = (event) => {
                connectionStatus.textContent = 'تم قطع الاتصال';
                connectionStatus.className = 'absolute top-4 left-4 text-sm px-3 py-1 rounded-full bg-red-600 text-white font-bold';
                // رسائل مفيدة بناءً على رمز الإغلاق
                let reason = `رمز: ${event.code}`;
                if (event.code === 1000) reason = "اغلاق طبيعي";
                else if (event.code === 1006) reason = "تم قطع الاتصال بشكل غير طبيعي (الخادم غير مستجيب أو خطأ في البروتوكول)";
                else if (event.code === 1005) reason = "لم يتم تحديد سبب الاغلاق (الشبكة أو الخادم)";

                console.warn(`WebSocket disconnected (${reason}). Attempting reconnect in 3s...`);
                setTimeout(connectToServer, 3000); // Attempt to reconnect
            };

            ws.onerror = (error) => {
                connectionStatus.textContent = 'خطأ بالاتصال';
                connectionStatus.className = 'absolute top-4 left-4 text-sm px-3 py-1 rounded-full bg-red-600 text-white font-bold';
                console.error('WebSocket error occurred! This often means the server URL is wrong, the server is down, or a protocol mismatch (http vs https/ws vs wss). Check the SERVER_URL:', SERVER_URL, error);
            };
        }

        // Custom Modal / Alert (replaces alert() and confirm())
        function alertUser(title, message) {
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[100]">
                    <div class="ui-panel max-w-sm w-full p-6 text-center border-2 border-red-500">
                        <h3 class="text-xl font-bold mb-3 text-red-400">${title}</h3>
                        <p class="text-sm mb-6 text-white">${message}</p>
                        <button onclick="document.getElementById('custom-alert-modal').remove()" class="w-full bg-blue-600 hover:bg-blue-700 font-bold py-2 rounded-lg transition duration-150">
                            حسناً
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // --- Rendering and Drawing ---

        function drawGame() {
            const now = performance.now();
            const delta = now - lastFrameTime;
            lastFrameTime = now;
            fps = Math.round(1000 / delta);

            // 1. Clear the canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 2. Center the camera on the current player
            myPlayer = gameState.players.find(p => p.id === myId);
            if (myPlayer) {
                camera.x = myPlayer.x - canvas.width / 2;
                camera.y = myPlayer.y - canvas.height / 2;
                currentScoreDisplay.textContent = Math.floor(myPlayer.score); // تحديث الدرجة في الداشبورد
                fpsDisplay.textContent = fps; // تحديث معدل الإطار
            }

            // 3. Draw the Game Boundary (Background)
            ctx.fillStyle = '#080514'; // لون خلفية أغمق
            ctx.fillRect(0 - camera.x, 0 - camera.y, worldSize.width, worldSize.height);

            // Draw a grid pattern for better visual context
            const gridSize = 100;
            ctx.strokeStyle = '#220d3f'; // لون شبكة خفيف
            ctx.lineWidth = 1;

            for (let x = 0; x < worldSize.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x - camera.x, 0 - camera.y);
                ctx.lineTo(x - camera.x, worldSize.height - camera.y);
                ctx.stroke();
            }
            for (let y = 0; y < worldSize.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0 - camera.x, y - camera.y);
                ctx.lineTo(worldSize.width - camera.x, y - camera.y);
                ctx.stroke();
            }

            // Draw border
            ctx.strokeStyle = '#4a0e7e';
            ctx.lineWidth = 15;
            ctx.strokeRect(0 - camera.x, 0 - camera.y, worldSize.width, worldSize.height);


            // 4. Draw Food
            gameState.food.forEach(f => {
                ctx.beginPath();
                ctx.arc(f.x - camera.x, f.y - camera.y, f.r, 0, Math.PI * 2);
                ctx.fillStyle = f.color;
                ctx.fill();
                ctx.closePath();
            });

            // 5. Draw Players
            gameState.players.forEach(p => {
                // Skip if player is too far off-screen (optimization)
                if (p.x + p.r < camera.x || p.x - p.r > camera.x + canvas.width ||
                    p.y + p.r < camera.y || p.y - p.r > camera.y + canvas.height) {
                    return;
                }

                // Draw the body circle
                ctx.beginPath();
                ctx.arc(p.x - camera.x, p.y - camera.y, p.r, 0, Math.PI * 2);
                
                // Shadow for depth
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 10;
                ctx.shadowOffsetX = 3;
                ctx.shadowOffsetY = 3;

                ctx.fillStyle = p.color;
                ctx.fill();
                
                // Reset shadow for subsequent drawings
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;

                // Draw a thick outline
                ctx.strokeStyle = '#1e1e1e';
                ctx.lineWidth = 6;
                ctx.stroke();
                ctx.closePath();

                // Draw the name and score
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.font = '900 14px Orbitron';
                ctx.fillText(p.name, p.x - camera.x, p.y - camera.y - 10);
                ctx.font = '400 12px Orbitron';
                ctx.fillText(Math.floor(p.score), p.x - camera.x, p.y - camera.y + 15);

                // Draw special visual if it's "me"
                if (p.id === myId) {
                    ctx.strokeStyle = '#8A2BE2'; // بنفسجي ساطع
                    ctx.lineWidth = 4;
                    ctx.stroke(); // Draw the stroke again for a highlight effect
                }
            });

            // 6. Update Leaderboard
            updateLeaderboard();

            // 7. Request next frame
            requestAnimationFrame(drawGame);
        }

        // --- Input Handling ---

        function sendInput() {
            if (ws && ws.readyState === WebSocket.OPEN && myPlayer) {
                // Calculate target position in world coordinates
                const targetX = camera.x + mousePos.x;
                const targetY = camera.y + mousePos.y;

                ws.send(JSON.stringify({
                    type: 'move',
                    x: targetX,
                    y: targetY,
                }));
            }
        }

        function handleMouseMove(event) {
            const rect = canvas.getBoundingClientRect();
            mousePos.x = event.clientX - rect.left;
            mousePos.y = event.clientY - rect.top;
        }

        function updateLeaderboard() {
            // Sort players by score (radius) descending
            const sortedPlayers = [...gameState.players].sort((a, b) => b.score - a.score).slice(0, 10);

            leaderboardList.innerHTML = ''; // Clear existing list

            sortedPlayers.forEach((p, index) => {
                const isMe = p.id === myId;
                const li = document.createElement('li');
                
                let scoreText = Math.floor(p.score);
                let rankClass = '';
                
                if (index === 0) rankClass = 'text-yellow-400 font-black';
                else if (index === 1) rankClass = 'text-gray-300 font-bold';
                else if (index === 2) rankClass = 'text-orange-500 font-bold';
                
                li.className = `${rankClass} ${isMe ? 'bg-purple-900/40' : ''}`;
                li.innerHTML = `
                    <span class="w-6">${index + 1}.</span>
                    <span class="flex-grow truncate ${isMe ? 'text-white' : ''}">${p.name.substring(0, 15)}</span>
                    <span class="w-16 text-right">${scoreText}</span>
                `;
                leaderboardList.appendChild(li);
            });
        }

        // --- Initialization and Events ---

        function resizeCanvas() {
            // يتم ضبط حجم اللوحة ليتناسب مع نافذة العرض
            canvas.width = window.innerWidth * 0.95; // 95% of screen width
            canvas.height = window.innerHeight * 0.85; // 85% of screen height
        }

        startGameButton.addEventListener('click', () => {
            const name = playerNameInput.value.trim() || 'Anonymous Player';
            if (ws && ws.readyState === WebSocket.OPEN) {
                // Send the chosen name to the server
                ws.send(JSON.stringify({ type: 'name', name: name }));
                // Hide the modal and show dashboard
                nameModal.classList.add('hidden');
                document.getElementById('leaderboard').classList.remove('hidden');
                dashboard.classList.remove('hidden');
                requestAnimationFrame(drawGame); // Start rendering
            } else {
                alertUser('خطأ في الاتصال', 'الخادم غير متصل. الرجاء التأكد من رابط الخادم أو محاولة إعادة الاتصال.');
                // Try to reconnect if starting failed
                setTimeout(connectToServer, 1000);
            }
        });


        // Input loop to send continuous movement updates
        setInterval(sendInput, INPUT_DELAY);

        // Event Listeners
        window.addEventListener('resize', resizeCanvas);
        canvas.addEventListener('mousemove', handleMouseMove);

        // Initial setup on load
        window.onload = function() {
            resizeCanvas();
            connectToServer();
        };

    </script>
</body>
</html>
